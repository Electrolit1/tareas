<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tareas del Hogar</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #1e1e2f;
      color: #ddd;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
      color: #2196f3;
    }
    .task-card {
      background: #2c2c44;
      border-left: 5px solid #2196f3;
      margin: 10px auto;
      padding: 15px;
      border-radius: 8px;
      max-width: 600px;
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.5);
      position: relative;
      word-wrap: break-word;
      opacity: 0;
      animation: fadeIn 0.4s ease forwards;
      cursor: default;
      user-select: none;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .task-card.confirmed {
      background-color: #2a4d2a !important;
      border-left-color: #4caf50 !important;
      cursor: pointer;
      user-select: text;
    }
    .task-card.not-confirmed {
      background-color: #4a472a !important;
      border-left-color: #ffd54f !important;
      cursor: pointer;
      user-select: text;
    }
    .task-card strong {
      color: #ffd54f;
    }
    #loginForm, #adminPanel {
      display: none;
      max-width: 400px;
      margin: 20px auto;
      background: #2c2c44;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(33,150,243,0.5);
    }
    input, button, textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 5px;
      border: none;
      font-size: 1rem;
      box-sizing: border-box;
    }
    input, textarea {
      background: #3a3a57;
      color: #eee;
      border: 1px solid #2196f3;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: #ffd54f;
    }
    button {
      background: #2196f3;
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    button:disabled {
      background: #555;
      cursor: default;
    }
    button:hover:enabled {
      background: #1976d2;
    }
    #logoutBtn {
      background: #e53935;
      margin-top: 15px;
    }
    #logoutBtn:hover {
      background: #b71c1c;
    }
    #btnSoyPadre {
      text-align: center;
      margin-top: 30px;
    }
    #btnSoyPadre button {
      width: auto;
      padding: 12px 25px;
      font-size: 1.1rem;
    }
    .task-card button {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #e53935;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      opacity: 0.85;
      transition: opacity 0.2s ease;
      user-select: none;
    }
    .task-card button:hover {
      opacity: 1;
      background: #b71c1c;
    }
    .task-card button.edit-btn {
      right: 45px;
      background: #ffd54f;
      color: #121212;
      font-weight: bold;
    }
    /* Contenedor para el input + bot√≥n enviar sobre la tarea */
    .input-enviar-container {
      max-width: 600px;
      margin: 10px auto 0 auto;
      padding: 10px 15px;
      background: #2c2c44;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
      display: flex;
      gap: 10px;
      opacity: 0;
      animation: fadeIn 0.4s ease forwards;
      max-width: 600px;
    }
    .input-enviar-container textarea {
      flex-grow: 1;
      height: 40px;
      resize: vertical;
      font-size: 0.9rem;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #2196f3;
      background: #3a3a57;
      color: #eee;
    }
    .input-enviar-container button {
      width: 100px;
      padding: 10px 5px;
      font-weight: 600;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <h1>üìã Tareas del Hogar</h1>

  <div id="taskList"></div>

  <div id="btnSoyPadre" style="text-align:center; margin-top: 20px;">
    <button id="btnMostrarLogin">üë§ Soy Padre</button>
  </div>

  <div id="loginForm">
    <h2>üîê Iniciar sesi√≥n</h2>
    <input type="text" id="username" placeholder="Usuario" autocomplete="username" />
    <input type="password" id="password" placeholder="Contrase√±a" autocomplete="current-password" />
    <button id="btnLogin">Entrar</button>
    <button id="btnCerrarLogin" style="background:#e53935; margin-top:10px;">Cerrar</button>
  </div>

  <div id="adminPanel">
    <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Panel de Tareas</h2>
    <input type="text" id="descripcion" placeholder="Descripci√≥n de la tarea" />
    <input type="text" id="para" placeholder="¬øPara qui√©n es?" />
    <input type="text" id="autor" placeholder="¬øQui√©n la escribi√≥?" />
    <input type="date" id="fecha" />
    <button id="btnAgregarTarea">Agregar Tarea</button>
    <div id="adminTasks"></div>
    <button id="logoutBtn">Salir del Panel</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs,
      deleteDoc, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA1LqppWSU8KGVNw9xbkFkU1BJLAw0EdUo",
      authDomain: "tareas-542bb.firebaseapp.com",
      projectId: "tareas-542bb",
      storageBucket: "tareas-542bb.appspot.com",
      messagingSenderId: "774046945636",
      appId: "1:774046945636:web:c26868684cfdd9acd66a71",
      measurementId: "G-JF2V8974BX"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM elements
    const btnMostrarLogin = document.getElementById("btnMostrarLogin");
    const loginForm = document.getElementById("loginForm");
    const btnCerrarLogin = document.getElementById("btnCerrarLogin");
    const btnLogin = document.getElementById("btnLogin");
    const btnSoyPadre = document.getElementById("btnSoyPadre");
    const adminPanel = document.getElementById("adminPanel");
    const logoutBtn = document.getElementById("logoutBtn");
    const btnAgregarTarea = document.getElementById("btnAgregarTarea");
    const taskList = document.getElementById("taskList");
    const adminTasks = document.getElementById("adminTasks");

    let isAdmin = false;
    let editandoId = null;

    // --- LocalStorage keys
    const LS_CONFIRMADAS = "tareas_confirmadas";
    const LS_TEXTOS = "tareas_textos";

    // Leer confirmadas de localStorage
    function leerConfirmadas() {
      const data = localStorage.getItem(LS_CONFIRMADAS);
      return data ? JSON.parse(data) : [];
    }

    // Guardar confirmadas en localStorage
    function guardarConfirmadas(arr) {
      localStorage.setItem(LS_CONFIRMADAS, JSON.stringify(arr));
    }

    // Leer textos de localStorage
    function leerTextos() {
      const data = localStorage.getItem(LS_TEXTOS);
      return data ? JSON.parse(data) : {};
    }

    // Guardar textos en localStorage
    function guardarTextos(obj) {
      localStorage.setItem(LS_TEXTOS, JSON.stringify(obj));
    }

    // Alternar confirmaci√≥n de tarea
    function toggleConfirmacion(id) {
      let confirmadas = leerConfirmadas();
      if (confirmadas.includes(id)) {
        confirmadas = confirmadas.filter(tid => tid !== id);
      } else {
        confirmadas.push(id);
      }
      guardarConfirmadas(confirmadas);
      return confirmadas.includes(id);
    }

    btnMostrarLogin.addEventListener("click", () => {
      loginForm.style.display = "block";
      btnSoyPadre.style.display = "none";
    });

    btnCerrarLogin.addEventListener("click", () => {
      loginForm.style.display = "none";
      if (!isAdmin) btnSoyPadre.style.display = "block";
    });

    btnLogin.addEventListener("click", () => {
      const user = document.getElementById("username").value.trim();
      const pass = document.getElementById("password").value.trim();
      if (user === "Admin" && pass === "familia2025") {
        isAdmin = true;
        loginForm.style.display = "none";
        adminPanel.style.display = "block";
        mostrarTareas("adminTasks", true);
        btnSoyPadre.style.display = "none";
      } else {
        alert("Credenciales incorrectas.");
      }
    });

    logoutBtn.addEventListener("click", () => {
      isAdmin = false;
      adminPanel.style.display = "none";
      btnSoyPadre.style.display = "block";
      mostrarTareas(); // Vista p√∫blica
      editandoId = null;
      btnAgregarTarea.textContent = "Agregar Tarea";
      limpiarFormulario();
    });

    btnAgregarTarea.addEventListener("click", async () => {
      const descripcion = document.getElementById("descripcion").value.trim();
      const para = document.getElementById("para").value.trim();
      const fecha = document.getElementById("fecha").value;
      const autor = document.getElementById("autor").value.trim();

      if (!descripcion || !para || !fecha || !autor) {
        alert("Completa todos los campos");
        return;
      }

      if (editandoId) {
        // Editar tarea
        await updateDoc(doc(db, "tareas", editandoId), {
          descripcion, para, fecha, autor
        });
        alert("Tarea actualizada.");
        editandoId = null;
        btnAgregarTarea.textContent = "Agregar Tarea";
      } else {
        // Crear nueva tarea
        await addDoc(collection(db, "tareas"), {
          descripcion, para, fecha, autor
        });
        alert("Tarea agregada con √©xito.");
      }

      limpiarFormulario();
      mostrarTareas("adminTasks", true);
      mostrarTareas();
    });

    function limpiarFormulario() {
      document.getElementById("descripcion").value = "";
      document.getElementById("para").value = "";
      document.getElementById("fecha").value = "";
      document.getElementById("autor").value = "";
    }

    // Carga tareas (p√∫blico o admin)
    async function mostrarTareas(destino = "taskList", mostrarEliminar = false) {
      const lista = document.getElementById(destino);
      lista.innerHTML = "";

      const confirmadas = leerConfirmadas();
      const textos = leerTextos();

      const querySnapshot = await getDocs(collection(db, "tareas"));
      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();

        // Crear contenedor tarea
        const div = document.createElement("div");
        div.className = "task-card";

        // Estado confirmaci√≥n
        if (confirmadas.includes(docSnap.id)) {
          div.classList.add("confirmed");
          div.title = "Tarea confirmada como hecha. Haz click para desmarcar.";
        } else {
          div.classList.add("not-confirmed");
          div.title = "Tarea no confirmada. Haz click para marcar como hecha.";
        }

        // Contenido principal tarea
        div.innerHTML = `
          <strong>${data.descripcion}</strong><br>
          Para: ${data.para}<br>
          Fecha: ${data.fecha}<br>
          Escrito por: ${data.autor}
        `;

        if (mostrarEliminar) {
          // Bot√≥n eliminar
          const btnEliminar = document.createElement("button");
          btnEliminar.textContent = "√ó";
          btnEliminar.title = "Eliminar tarea";
          btnEliminar.classList.add("delete-btn");
          btnEliminar.onclick = async (e) => {
            e.stopPropagation();
            if (confirm("¬øSeguro quieres eliminar esta tarea?")) {
              await deleteDoc(doc(db, "tareas", docSnap.id));
              mostrarTareas("adminTasks", true);
              mostrarTareas();
            }
          };
          div.appendChild(btnEliminar);

          // Bot√≥n editar
          const btnEditar = document.createElement("button");
          btnEditar.textContent = "‚úé";
          btnEditar.title = "Editar tarea";
          btnEditar.classList.add("edit-btn");
          btnEditar.onclick = (e) => {
            e.stopPropagation();
            editandoId = docSnap.id;
            document.getElementById("descripcion").value = data.descripcion;
            document.getElementById("para").value = data.para;
            document.getElementById("fecha").value = data.fecha;
            document.getElementById("autor").value = data.autor;
            btnAgregarTarea.textContent = "Guardar Cambios";
            window.scrollTo({ top: 0, behavior: "smooth" });
          };
          div.appendChild(btnEditar);
        } else {
          // Si no es admin, permitir confirmar y a√±adir texto y bot√≥n enviar

          // Contenedor para el input y bot√≥n enviar que se mostrar√° arriba de la tarea
          const containerInputEnviar = document.createElement("div");
          containerInputEnviar.className = "input-enviar-container";
          containerInputEnviar.style.display = "none"; // Oculto inicialmente

          const textarea = document.createElement("textarea");
          textarea.placeholder = "Escribe un comentario breve...";
          textarea.value = textos[docSnap.id] || "";
          containerInputEnviar.appendChild(textarea);

          const btnEnviar = document.createElement("button");
          btnEnviar.textContent = "Enviar";
          btnEnviar.disabled = textarea.value.trim().length === 0;
          containerInputEnviar.appendChild(btnEnviar);

          // Insertar el contenedor input enviar justo antes de la tarea (en el DOM)
          lista.appendChild(containerInputEnviar);
          lista.appendChild(div);

          // Mostrar el texto guardado si existe y la tarea est√° confirmada
          if (confirmadas.includes(docSnap.id) && textos[docSnap.id]) {
            const pTexto = document.createElement("p");
            pTexto.textContent = textos[docSnap.id];
            pTexto.style.background = "#3a3a57";
            pTexto.style.padding = "6px 10px";
            pTexto.style.borderRadius = "5px";
            pTexto.style.whiteSpace = "pre-wrap";
            pTexto.style.margin = "8px 0 0 0";
            div.appendChild(pTexto);
          }

          // Funci√≥n para mostrar/ocultar input + boton
          function toggleInputEnviar(show) {
            containerInputEnviar.style.display = show ? "flex" : "none";
            if (show) textarea.focus();
          }

          // Manejar clic para confirmar/desconfirmar tarea
          div.addEventListener("click", () => {
            const ahoraConfirmada = toggleConfirmacion(docSnap.id);

            if (ahoraConfirmada) {
              div.classList.remove("not-confirmed");
              div.classList.add("confirmed");
              div.title = "Tarea confirmada como hecha. Haz click para desmarcar.";

              toggleInputEnviar(true);
              textarea.value = textos[docSnap.id] || "";
              btnEnviar.disabled = textarea.value.trim().length === 0;
            } else {
              div.classList.remove("confirmed");
              div.classList.add("not-confirmed");
              div.title = "Tarea no confirmada. Haz click para marcar como hecha.";

              toggleInputEnviar(false);
              // Borrar texto guardado
              const textosAct = leerTextos();
              delete textosAct[docSnap.id];
              guardarTextos(textosAct);
              // Quitar p√°rrafo con texto si existe
              const pTexto = div.querySelector("p");
              if (pTexto) pTexto.remove();
            }
          });

          // Activar/desactivar bot√≥n enviar seg√∫n textarea
          textarea.addEventListener("input", () => {
            btnEnviar.disabled = textarea.value.trim().length === 0;
          });

          // Al presionar enviar, guardar texto y mostrarlo bajo la tarea
          btnEnviar.addEventListener("click", (e) => {
            e.stopPropagation();
            const texto = textarea.value.trim();
            if (!texto) return;

            // Guardar texto en localStorage
            const textosAct = leerTextos();
            textosAct[docSnap.id] = texto;
            guardarTextos(textosAct);

            // Mostrar texto bajo la tarea
            // Eliminar textarea y bot√≥n
            toggleInputEnviar(false);

            // Actualizar el p√°rrafo o crearlo si no existe
            let pTexto = div.querySelector("p");
            if (!pTexto) {
              pTexto = document.createElement("p");
              div.appendChild(pTexto);
            }
            pTexto.textContent = texto;
            pTexto.style.background = "#3a3a57";
            pTexto.style.padding = "6px 10px";
            pTexto.style.borderRadius = "5px";
            pTexto.style.whiteSpace = "pre-wrap";
            pTexto.style.margin = "8px 0 0 0";
          });
        }
      });

      if (lista.innerHTML.trim() === "") {
        lista.innerHTML = '<p style="text-align:center; color:#888;">No hay tareas a√∫n.</p>';
      }
    }

    mostrarTareas(); // Carga inicial p√∫blica
  </script>
</body>
</html>
